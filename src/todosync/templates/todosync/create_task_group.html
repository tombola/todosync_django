{% extends "todosync/base.html" %}

{% block title %}Create Tasks from Template{% endblock %}

{% block content %}
<h1>Create Tasks from Template</h1>

{% if messages %}
<div class="messages">
    {% for message in messages %}
    <div class="message {{ message.tags }}">{{ message }}</div>
    {% endfor %}
</div>
{% endif %}

{{ token_field_names|json_script:"token-field-names" }}

<div x-data="taskPreview()" class="create-task-layout">

<form method="post">
    {% csrf_token %}

    {% if template_id %}
    <input type="hidden" name="template_id" value="{{ template_id }}">
    {% endif %}

    {# Render task_group_template field first #}
    <div>
        <label for="{{ form.task_group_template.id_for_label }}">
            {{ form.task_group_template.label }}
        </label>
        {{ form.task_group_template }}
        {% if form.task_group_template.help_text %}
        <p class="help-text">{{ form.task_group_template.help_text }}</p>
        {% endif %}
        {% if form.task_group_template.errors %}
        <div class="error">
            {{ form.task_group_template.errors }}
        </div>
        {% endif %}
    </div>

    {# Render token fields #}
    {% for field in form %}
        {% if field.name != 'task_group_template' and field.name != 'description' %}
        <div>
            <label for="{{ field.id_for_label }}">{{ field.label }}</label>
            {{ field }}
            {% if field.errors %}
            <div class="error">{{ field.errors }}</div>
            {% endif %}
        </div>
        {% endif %}
    {% endfor %}

    {# Description field, collapsed by default #}
    {% if form.description %}
    <details>
        <summary>{{ form.description.label }}</summary>
        <div>
            {{ form.description }}
            {% if form.description.errors %}
            <div class="error">{{ form.description.errors }}</div>
            {% endif %}
        </div>
    </details>
    {% endif %}

    {% if template_id %}
    <button type="submit" class="button">Create Tasks</button>
    {% endif %}
</form>

{% if selected_template %}
<div class="task-preview">
    {% if parent_task_title_template %}
    <h3><span x-text="replace('{{ parent_task_title_template|escapejs }}')">{{ parent_task_title_template }}</span></h3>
    {% endif %}

    {% if parent_task_description_template %}
    <pre class="description-text" x-text="replace('{{ parent_task_description_template|escapejs }}')">{{ parent_task_description_template }}</pre>
    {% endif %}

    <template x-if="additionalDescription.trim()">
        <pre class="description-text" x-text="replace(additionalDescription)"></pre>
    </template>

    <div class="task-structure">
        {% if selected_template.tasks %}
        <ul class="task-list">
            {% for task in selected_template.tasks %}
                <li class="task-item">
                    <strong x-text="replace('{{ task.title|escapejs }}')">{{ task.title }}</strong>
                    {% if task.labels %}
                    <span class="task-labels"><em>({{ task.labels }})</em></span>
                    {% endif %}

                    {% if task.depends_on %}
                    <span class="task-dependency">depends on: {{ task.depends_on.title }}</span>
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="no-tasks">No tasks defined in this template.</p>
        {% endif %}
    </div>
</div>
{% endif %}

{% if not selected_template %}
<div></div>{# empty column when no preview #}
{% endif %}

</div>{# /x-data .create-task-layout #}
{% endblock %}

{% block extra_js %}
<script>
function taskPreview() {
    const el = document.getElementById('token-field-names');
    const names = el ? JSON.parse(el.textContent) : [];
    return {
        tokens: Object.fromEntries(names.map(n => [n, ''])),
        additionalDescription: '',
        replace(text) {
            let result = text;
            for (const [key, val] of Object.entries(this.tokens)) {
                result = result.replaceAll('{' + key + '}', val || ('{' + key + '}'));
            }
            return result;
        },
        init() {
            for (const name of names) {
                const input = document.querySelector('[name="token_' + name + '"]');
                if (input) {
                    if (input.value) this.tokens[name] = input.value;
                    input.addEventListener('input', e => { this.tokens[name] = e.target.value; });
                }
            }
            const desc = document.querySelector('[name="description"]');
            if (desc) {
                if (desc.value) this.additionalDescription = desc.value;
                desc.addEventListener('input', e => { this.additionalDescription = e.target.value; });
            }
        }
    };
}

// Template selector: reload page with template_id when changed
document.addEventListener('DOMContentLoaded', function() {
    var templateSelect = document.querySelector('select[name="task_group_template"]');
    if (templateSelect) {
        templateSelect.addEventListener('change', function() {
            if (this.value) {
                window.location.href = '?template_id=' + this.value;
            }
        });
    }
});
</script>
{% endblock %}
